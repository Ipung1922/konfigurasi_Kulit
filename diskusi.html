<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ruang Diskusi - Konfigurasi Elektron</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  </head>

  <body
    class="min-h-screen bg-gradient-to-br from-pink-50 via-white to-blue-50"
  >
    <custom-navbar></custom-navbar>

    <main class="container mx-auto px-4 py-12 max-w-4xl">
      <h1 class="text-4xl md:text-5xl font-bold text-center mb-8 text-pink-800">
        ðŸ’¬ Ruang Diskusi
      </h1>

      <!-- Discussion Form -->
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <h2
          class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"
        >
          <i data-feather="message-square" class="w-5 h-5"></i>
          Tulis Pertanyaan atau Komentar
        </h2>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Nama</label
            >
            <input
              type="text"
              id="discussionName"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent"
              placeholder="Masukkan nama kamu..."
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Pesan</label
            >
            <textarea
              id="discussionMessage"
              rows="4"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent"
              placeholder="Tuliskan pertanyaan atau komentar tentang konfigurasi elektron..."
            ></textarea>
          </div>

          <button
            onclick="submitDiscussion()"
            class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-3 rounded-lg hover:from-pink-600 hover:to-purple-700 transition-all transform hover:scale-105"
          >
            Kirim Pesan
          </button>
        </div>
      </div>

      <!-- Discussions Container -->
      <div id="discussionsContainer" class="space-y-4"></div>

      <div id="loadingIndicator" class="hidden text-center py-4">
        <div
          class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-pink-600"
        ></div>
        <p class="text-gray-600 mt-2">Memuat diskusi...</p>
      </div>
    </main>

    <custom-footer></custom-footer>

    <script src="components/navbar.js"></script>
    <script src="components/footer.js"></script>

    <script>
      // =========================================================
      // Konfigurasi Firebase
      // =========================================================
      const firebaseConfig = {
        apiKey: "AIzaSyA9QXVUPhObbf0mWJ24pHDIVTzAjW4FjaQ",
        authDomain: "kuis-29a9b.firebaseapp.com",
        databaseURL: "https://komen-4cce4-default-rtdb.firebaseio.com/",
        projectId: "kuis-29a9b",
        storageBucket: "kuis-29a9b.firebasestorage.app",
        messagingSenderId: "879477573039",
        appId: "1:879477573039:web:e9368951ded947a8975b5a",
        measurementId: "G-THF6SH9210",
      };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // =========================================================
      // Fungsi Menyimpan dan Memuat Diskusi
      // =========================================================
      function saveDiscussion(name, message) {
        const newRef = database.ref("discussions").push();
        const timestamp = new Date().toISOString();
        newRef.set({ id: newRef.key, name, message, timestamp });
      }

      function loadDiscussions(callback) {
        database.ref("discussions").on("value", (snapshot) => {
          const data = [];
          snapshot.forEach((child) => {
            data.push(child.val());
          });
          callback(data.reverse());
        });
      }

      // =========================================================
      // Fungsi Utama
      // =========================================================
      let discussions = [];

      function submitDiscussion() {
        const name = document.getElementById("discussionName").value.trim();
        const message = document
          .getElementById("discussionMessage")
          .value.trim();

        if (!name || !message) {
          alert("Silakan isi nama dan pesan terlebih dahulu!");
          return;
        }

        saveDiscussion(name, message);
        document.getElementById("discussionName").value = "";
        document.getElementById("discussionMessage").value = "";
      }

      function replyDiscussion(id) {
        const replyBoxId = `reply-box-${id}`;
        let replyBox = document.getElementById(replyBoxId);

        if (replyBox) {
          replyBox.classList.toggle("hidden");
          return;
        }

        const container = document.getElementById(`discussion-${id}`);
        const div = document.createElement("div");
        div.id = replyBoxId;
        div.className =
          "ml-12 mt-3 bg-gray-50 p-3 rounded-lg border border-gray-200";
        div.innerHTML = `
          <input id="replyName-${id}" type="text" placeholder="Nama kamu..." class="w-full mb-2 px-3 py-2 border rounded-lg" />
          <textarea id="replyMessage-${id}" placeholder="Tulis balasan..." rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
          <button onclick="submitReply('${id}')" class="mt-2 bg-pink-500 hover:bg-pink-600 text-white px-3 py-1 rounded-lg">Kirim Balasan</button>
        `;
        container.appendChild(div);
      }

      function submitReply(parentId) {
        const name = document
          .getElementById(`replyName-${parentId}`)
          .value.trim();
        const message = document
          .getElementById(`replyMessage-${parentId}`)
          .value.trim();

        if (!name || !message) {
          alert("Isi nama dan balasan terlebih dahulu!");
          return;
        }

        const replyRef = database.ref(`discussions/${parentId}/replies`).push();
        replyRef.set({
          name,
          message,
          timestamp: new Date().toISOString(),
        });
      }

      function renderDiscussions() {
        const container = document.getElementById("discussionsContainer");
        container.innerHTML = discussions
          .map((d) => {
            const initials = d.name[0].toUpperCase();
            const timeAgo = getTimeAgo(new Date(d.timestamp));

            let repliesHTML = "";
            let repliesButton = "";

            if (d.replies) {
              const replyList = Object.values(d.replies)
                .map(
                  (r) => `
              <div class="reply-item ml-12 mt-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <p class="font-semibold text-gray-700">${r.name}</p>
                <p class="text-gray-600 text-sm">${r.message}</p>
                <p class="text-xs text-gray-400">${getTimeAgo(
                  new Date(r.timestamp)
                )}</p>
              </div>
            `
                )
                .join("");

              repliesHTML = `<div id="replies-${d.id}" class="hidden">${replyList}</div>`;
              repliesButton = `
          <button onclick="toggleReplies('${d.id}')" 
                  class="mt-2 text-sm text-blue-600 hover:underline">
            Lihat Balasan (${Object.keys(d.replies).length})
          </button>`;
            }

            return `
        <div id="discussion-${d.id}" class="bg-white p-4 rounded-xl shadow-md">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-pink-400 to-purple-500 text-white rounded-full flex items-center justify-center font-bold">${initials}</div>
            <div>
              <p class="font-semibold text-gray-800">${d.name}</p>
              <p class="text-gray-700">${d.message}</p>
              <p class="text-xs text-gray-400">${timeAgo}</p>
              <div class="flex gap-3 mt-2">
                <button onclick="replyDiscussion('${d.id}')" class="text-pink-600 text-sm hover:underline">Balas</button>
                ${repliesButton}
              </div>
            </div>
          </div>
          ${repliesHTML}
        </div>
      `;
          })
          .join("");

        feather.replace();
      }
      function toggleReplies(id) {
        const repliesDiv = document.getElementById(`replies-${id}`);
        if (!repliesDiv) return;

        repliesDiv.classList.toggle("hidden");

        const button = event.target;
        if (repliesDiv.classList.contains("hidden")) {
          button.textContent = "Lihat Balasan";
        } else {
          const count = repliesDiv.querySelectorAll(".reply-item").length;
          button.textContent = `Sembunyikan Balasan (${count})`;
        }
      }

      function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return "Baru saja";
        if (seconds < 3600) return `${Math.floor(seconds / 60)} menit lalu`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)} jam lalu`;
        return `${Math.floor(seconds / 86400)} hari lalu`;
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadDiscussions((data) => {
          discussions = data;
          renderDiscussions();
        });
      });
    </script>
  </body>
</html>
